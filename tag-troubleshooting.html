<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://whatacold.github.io/rss.xml"
      title="RSS feed for https://whatacold.github.io/">
<title>whatacold's blog site</title>
<meta name="author" content="Guangwang Huang">
<meta name="referrer" content="no-referrer">
<link href= "static/style.css" rel="stylesheet" type="text/css" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-74588785-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-74588785-1');
</script>
</head>
<body>
<div id="preamble" class="status"><div class="header">
<div class="sitelinks">
    <a href="https://github.com/whatacold">GitHub</a> | <a href="https://stackoverflow.com/users/910978/whatacold">Stack Overflow</a> | <a href="mailto:whatacold@gmail.com">Email</a> | <a href="/rss.xml">RSS</a>
</div></div>
<div id="content">
<h1 class="title">Posts tagged "troubleshooting":</h1>
<div class="post-date">30 May 2020</div><h1 class="post-title"><a href="https://whatacold.github.io/2020-05-30-a-trick-to-troubleshoot-emacs-subprocess-creating.html">A Trick to Troubleshoot Emacs Subprocess Creating</a></h1>
<p>
There are many packages of Emacs that leverage subprocesses to do their jobs, <a href="https://magit.vc/">Magit</a>, <a href="https://github.com/joaotavora/eglot">eglot</a>, <a href="https://github.com/jorgenschaefer/elpy">elpy</a>, to name a few. And there are times that a subprocess doesn't work as expected, for example, Magit is slow, and you're sure that it's ok when running git commands on shell. So how to spot these problems effectively and quickly?
</p>

<p>
The problem is that we don't know what's going on exactly, so here I want to share a few Elisp advice to make the subprocess creating visible, and print the exact program and its arguments to the <code>*Message*</code> buffer. Visibility is the key.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #2c3e50; font-style: italic;">defvar</span> <span style="color: #3498db;">trace-subprocess-p</span> nil
  <span style="color: #16a085;">"Whether to trace subprocess creating or not."</span>)

(<span style="color: #2c3e50; font-style: italic;">defun</span> <span style="color: #9b59b6;">my-toggle-trace-subprocess</span> ()
  <span style="color: #16a085;">"Toggle whether to trace subprocess creating."</span>
  (<span style="color: #2c3e50; font-style: italic;">interactive</span>)
  (<span style="color: #2c3e50; font-style: italic;">setq</span> trace-subprocess-p (not trace-subprocess-p))
  (<span style="color: #2c3e50; font-style: italic;">when</span> trace-subprocess-p
    (message <span style="color: #16a085;">"Trace subprocess creating."</span>)))

(<span style="color: #2c3e50; font-style: italic;">defun</span> <span style="color: #9b59b6;">my-quote-argument</span> (arg)
  <span style="color: #16a085;">"Double quote ARG."</span>
  (concat <span style="color: #16a085;">"\""</span> arg <span style="color: #16a085;">"\""</span>))

(<span style="color: #2c3e50; font-style: italic;">define-advice</span> <span style="color: #9b59b6;">start-process</span> (<span style="color: #2c3e50;">:before</span> (name buffer program <span style="color: #27ae60;">&amp;rest</span> program-args) trace)
  (<span style="color: #2c3e50; font-style: italic;">when</span> trace-subprocess-p
    (message <span style="color: #16a085;">"Trace start-process: name: %s, buffer: %s, program and args: %s %s"</span>
             name buffer program
             (mapconcat #'my-quote-argument program-args <span style="color: #16a085;">" "</span>))))

(<span style="color: #2c3e50; font-style: italic;">define-advice</span> <span style="color: #9b59b6;">shell-command-to-string</span> (<span style="color: #2c3e50;">:before</span> (command) trace)
  (<span style="color: #2c3e50; font-style: italic;">when</span> trace-subprocess-p
    (message <span style="color: #16a085;">"Trace shell-command-to-string: %s"</span> command)))

(<span style="color: #2c3e50; font-style: italic;">define-advice</span> <span style="color: #9b59b6;">call-process</span> (<span style="color: #2c3e50;">:before</span> (program <span style="color: #27ae60;">&amp;optional</span> infile destination display <span style="color: #27ae60;">&amp;rest</span> args) trace)
  (<span style="color: #2c3e50; font-style: italic;">when</span> trace-subprocess-p
    (message <span style="color: #16a085;">"Trace call-process: %s %s"</span>
             program
             (mapconcat #'my-quote-argument args <span style="color: #16a085;">" "</span>))))
</pre>
</div>

<p>
Add these to your <code>.emacs.d</code> and type <code>M-x my-toggle-trace-subprocess RET</code> when you want to see what is going on under the neath. The following is how it looks like when I run <code>M-x elpy-mode</code> on a Python buffer:
</p>

<pre class="example">
Trace start-process: name:  *elpy-rpc [project:~/python/qtile/ environment:/home/whatacold/virtualenv/elpy]*, buffer:  *elpy-rpc [project:~/python/qtile/ environment:/home/whatacold/virtualenv/elpy]*, program and args: /home/whatacold/.emacs.d/elpy/rpc-venv/bin/python "-W" "ignore" "-m" "elpy.__main__"
</pre>

<p>
With the help of these advice, I successfully resolved a performance issue of Magit with a particular repo the other day, which was caused by <a href="https://github.com/emacsorphanage/magit-svn">magit-svn</a> hooks.
</p>
<div class="taglist"><a href="https://whatacold.github.io/tags.html">Tags</a>: <a href="https://whatacold.github.io/tag-emacs.html">Emacs</a> <a href="https://whatacold.github.io/tag-troubleshooting.html">troubleshooting</a> </div>
<div class="post-date">04 Feb 2020</div><h1 class="post-title"><a href="https://whatacold.github.io/2020-02-04-binary-search-algorithm-vs-problem-solving.html">The binary search algorithm is also an efficient strategy for narrowing down problem space</a></h1>
<p>
<a href="https://en.wikipedia.org/wiki/Binary_search_algorithm">Binary search algorithm</a> is a search algorithm that finds the position of a target value within a sorted array. It cuts off the target array in half in a pass, so that it has a worst-case performance of <code>O(log n)</code>.
</p>


<figure>
<object type="image/svg+xml" data="https://upload.wikimedia.org/wikipedia/commons/8/83/Binary_Search_Depiction.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>

<figcaption><span class="figure-number">Figure 1: </span>Visualization of the binary search algorithm where 7 is the target value(@wikipedia)</figcaption>
</figure>

<p>
We all know that it's an efficient searching algorithm, but the strategy behind it also applies for narrowing down other problem space, for example, finding out when a bug is first introduced in a series of git commits.
</p>

<p>
Let's say I have a git repo of 8 commits, the first 5 of which are good, but then the 6th commit introduces a bug, so I have a git commit history looks like below:
</p>
<pre class="example">
 |g|g|g|g|g|b|b|b|
---------------------&gt; the git commit history
</pre>

<p>
So I know that the first commit is good and the last (8th) commit is bad (these are initial problem space), by leveraging the strategy of binary search, it can quickly find out that the 6th commit is the first bad commit. (Check the 4th element first, then the 6th.)
</p>

<p>
Well, that's basically how <code>git bisect</code> works, and it's more powerful, it can be run with a script to determine if current commit is good or not, saving time to verify it manually.
</p>

<p>
Recently, I managed to use <code>git bisect</code> to find out a recession bug <a href="https://github.com/qtile/qtile/issues/1410">(#1410)</a> of qtile, which reports that <code>qtile-cmd</code> doesn't work anymore which the HEAD commit (<code>0617235c</code>), but it works with tag <code>v0.14.2</code>.
</p>

<p>
With those in mind, here are the steps to catch the first bad commit:
</p>
<ol class="org-ol">
<li><p>
Start the bisect session: <code>git bisect start 0617235c v0.14.2</code>
</p>

<pre class="example">
$ git bisect start 0617235c v0.14.2
Bisecting: 88 revisions left to test after this (roughly 7 steps)
[082e4c7248ac40b69dbe94cfdc4de6aecc5f74ba] Fix debian version
</pre></li>

<li><p>
Make a judge script(attached at the end) and find out the commit by running <code>git bisect run ./scripts/git-bisect-judge</code>
</p>

<p>
It only takes git 6 steps to find the first broken commit, the output is following with qtile logs being removed:
</p>
<pre class="example">
$ git bisect run ./scripts/git-bisect-judge
running ./scripts/git-bisect-judge
Bisecting: 44 revisions left to test after this (roughly 6 steps)
[fdb3a324aadb0f934080a703d6835a9a7d203720] Delay power renormalization
running ./scripts/git-bisect-judge
...

Bisecting: 21 revisions left to test after this (roughly 5 steps)
[0262fbc2ca23d27fa33c4903d7e8a9b8c14d42eb] Move around modules
running ./scripts/git-bisect-judge
...

Bisecting: 10 revisions left to test after this (roughly 4 steps)
[a3ae3c623859b247813fc1876b188c4d40e84df0] Move calls out of the command graph
running ./scripts/git-bisect-judge
...

Bisecting: 5 revisions left to test after this (roughly 3 steps)
[036dbcb1b7c5c0fff00fbfbb9688597e2d2f188c] Add tests to the command graph
running ./scripts/git-bisect-judge
...

Bisecting: 2 revisions left to test after this (roughly 1 step)
[9c3c78ca66905b4e11bfd7a155cfe883cbe12ad6] Create new command graph
running ./scripts/git-bisect-judge
...

Bisecting: 0 revisions left to test after this (roughly 0 steps)
[ed5eefbf3482481c1f0f4c1cb2eb79e571fec835] Use correct type annotations in IPC module
running ./scripts/git-bisect-judge
...

ed5eefbf3482481c1f0f4c1cb2eb79e571fec835 is the first bad commit
commit ed5eefbf3482481c1f0f4c1cb2eb79e571fec835
Author: Sean Vig &lt;sean.v.775@gmail.com&gt;
Date:   Wed Jun 19 22:33:45 2019 -0400

    Use correct type annotations in IPC module

    With python/typeshed#3061 making it into the most recent release of
    mypy, remove the hacks on the type annotations around the marshal
    module.

:040000 040000 d21cc05b503a0f4658647adad3169efbd84eaa16 f80f29304abd86da9299dfaf22f6719698a37e63 M	libqtile
bisect run success
</pre></li>

<li>End the session by running <code>git bisect reset</code>, git will restores your previouse HEAD commit.</li>
</ol>

<p>
The judge script <code>git-bisect-judege</code> is below:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #95a5a6; font-style: italic;">#</span><span style="color: #95a5a6; font-style: italic;">!/bin/</span><span style="color: #2c3e50; font-style: italic;">sh</span>

<span style="color: #3498db;">HERE</span>=$(dirname $(readlink -f $<span style="color: #3498db;">0</span>))
<span style="color: #3498db;">SCREEN_SIZE</span>=${<span style="color: #3498db;">SCREEN_SIZE</span>:-1000x800}
<span style="color: #3498db;">XDISPLAY</span>=${<span style="color: #3498db;">XDISPLAY</span>:-:1}
<span style="color: #3498db;">LOG_LEVEL</span>=${<span style="color: #3498db;">LOG_LEVEL</span>:-DEBUG}
<span style="color: #3498db;">LOG_LEVEL</span>=INFO
<span style="color: #2c3e50; font-style: italic;">if</span> [[ -z $<span style="color: #3498db;">PYTHON</span> ]]; <span style="color: #2c3e50; font-style: italic;">then</span>
    <span style="color: #3498db;">PYTHON</span>=python
<span style="color: #2c3e50; font-style: italic;">fi</span>

./scripts/ffibuild

<span style="color: #3498db;">CLIENT</span>=<span style="color: #16a085;">"urxvt"</span>

Xephyr +extension RANDR -screen ${<span style="color: #3498db;">SCREEN_SIZE</span>} ${<span style="color: #3498db;">XDISPLAY</span>} -ac &amp;
<span style="color: #3498db;">XEPHYR_PID</span>=$<span style="color: #3498db;">!</span>
sleep 0.5
<span style="color: #2c3e50;">source</span> ~/workspace/virtualenv/qtile-devel/bin/activate
env <span style="color: #3498db;">DISPLAY</span>=${<span style="color: #3498db;">XDISPLAY</span>} ${<span style="color: #3498db;">PYTHON</span>} <span style="color: #16a085;">"${HERE}"</span>/../bin/qtile -l ${<span style="color: #3498db;">LOG_LEVEL</span>} $<span style="color: #3498db;">@</span> &amp;
<span style="color: #3498db;">QTILE_PID</span>=$<span style="color: #3498db;">!</span>

<span style="color: #2c3e50;">export</span> <span style="color: #3498db;">DISPLAY</span>=${<span style="color: #3498db;">XDISPLAY</span>}
<span style="color: #2c3e50;">cd</span> ~/workspace/python/qtile
sleep 0.5
./bin/qtile-cmd -o screen -f info
<span style="color: #3498db;">EXIT_CODE</span>=$<span style="color: #3498db;">?</span>

<span style="color: #2c3e50;">kill</span> -9 $<span style="color: #3498db;">QTILE_PID</span>
<span style="color: #2c3e50;">kill</span> $<span style="color: #3498db;">XEPHYR_PID</span>

<span style="color: #2c3e50; font-style: italic;">exit</span> $<span style="color: #3498db;">EXIT_CODE</span>
</pre>
</div>
<div class="taglist"><a href="https://whatacold.github.io/tags.html">Tags</a>: <a href="https://whatacold.github.io/tag-git.html">Git</a> <a href="https://whatacold.github.io/tag-troubleshooting.html">troubleshooting</a> </div><div id="archive">
<a href="https://whatacold.github.io/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status"></div>
</body>
</html>

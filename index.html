<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://whatacold.github.io/rss.xml"
      title="RSS feed for https://whatacold.github.io/"/>
<title>whatacold's blog site</title>
<meta name="author" content="Guangwang Huang">
<meta name="referrer" content="no-referrer">
<link href= "static/style.css" rel="stylesheet" type="text/css" /></head>
<body>
<div id="preamble" class="status"><div class="header">
<div class="sitelinks">
    <a href="https://github.com/whatacold">GitHub</a> | <a href="https://stackoverflow.com/users/910978/whatacold">Stack Overflow</a> | <a href="mailto:whatacold@gmail.com">Email</a> | <a href="/rss.xml">RSS</a>
</div></div>
<div id="content">

<div class="post-date">07 Oct 2019</div><h1 class="post-title"><a href="2019-10-07-build-docker-images-for-qtile.html">Build Docker Images for Qtile</a></h1>
<p>
One of Docker's use cases is to set up identical development environments easily and quickly for a dev team.
Recently, I had an opportunity to give it a try, and build Docker images for <a href="https://github.com/qtile/qtile">Qtile</a>, as it didn't have one yet as I get involved. With the images, it's easy to set up the environment to easily run the tests, and build the documentation.
</p>

<p>
The best way to have a basic idea of Docker is to think it like a chroot environment, as Chris Tankersley stated in his <a href="https://leanpub.com/dockerfordevs">Docker for Developers</a>.
And two basic concepts of Docker are image and container, containers to images are what objects to classes as in OOP terminology.
</p>

<p>
The instructions for building a Docker image are put in a <code>Dockerfile</code>, every command builds a new layer on top of the previous one so that I can build my image "on the shoulders of giants".
</p>

<p>
The final Dockerfiles for testing Qtile and building its documentation are hosted at <a href="https://github.com/whatacold/qtile-docker">https://github.com/whatacold/qtile-docker</a>, there is a brief README there about how to build them and use them.</p>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-docker.html">Docker</a> </div>
<div class="post-date">01 Oct 2019</div><h1 class="post-title"><a href="2019-10-01-reboot-tianyi-router-using-python-requests.html">用 Python Requests “一键”重启天翼路由器</a></h1>
<p>
不知道什么原因，我的网络有时候会很慢，而通过重启天翼网关路由器（版本 V1.0 ）大概率能够恢复。这样重启的次数多了之后会觉得有点繁琐，本着偷懒的原则，就想写一个脚本来自动重启，那样的话会“方便”很多。
</p>

<p>
经过一番折腾，查看其控制台的网页代码，最后终于搞定。通过使用 <a href="https://requests.kennethreitz.org/en/master/">Python Requests</a> 库串联登录及重启两个步骤，达到“一键”自动重启路由器的目的。 Python 脚本如下：
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #95a5a6; font-style: italic;">#</span><span style="color: #95a5a6; font-style: italic;">!/usr/bin/env python3</span>
<span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">-*- coding: utf-8 -*-</span>

<span style="color: #2c3e50; font-style: italic;">import</span> requests
<span style="color: #2c3e50; font-style: italic;">import</span> re

<span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">&#36825;&#37324;&#30340;&#37197;&#32622;&#65292;&#35831;&#25353;&#38656;&#20462;&#25913;&#12290;</span>
<span style="color: #3498db;">DEVICE_IP</span>=<span style="color: #16a085;">"192.168.1.1"</span>
<span style="color: #3498db;">USERNAME</span>=<span style="color: #16a085;">'admin'</span>
<span style="color: #3498db;">PASSWORD</span>=<span style="color: #16a085;">'foobar'</span>

<span style="color: #2c3e50; font-style: italic;">def</span> <span style="color: #9b59b6;">reboot</span>():
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #16a085;">'''Reboot the Tianyi Gateway automatically'''</span>
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #3498db;">s</span> = requests.Session()
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #3498db;">login_data</span> = <span style="color: #16a085;">"username={}&amp;password={}"</span>.<span style="color: #2c3e50;">format</span>(USERNAME, PASSWORD)
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #3498db;">response</span> = s.post(<span style="color: #16a085;">"http://{}/login.cgi"</span>.<span style="color: #2c3e50;">format</span>(DEVICE_IP), login_data)
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #3498db;">response_html</span> = response.text
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #3498db;">matches</span> = re.findall(<span style="color: #16a085;">'var mysessionid=([0-9]+);'</span>, response_html)
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #2c3e50; font-style: italic;">if</span> 1 != <span style="color: #2c3e50;">len</span>(matches):
<span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="color: #2c3e50; font-style: italic;">raise</span> <span style="color: #16a085;">"No session id matched!"</span>

<span style="background-color: #ecf0f1;"> </span>   <span style="color: #3498db;">session_id</span> = matches[0]
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">session_id = 1111 # It doesn't care what it REALLY is</span>
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #3498db;">response</span> = s.post(<span style="color: #16a085;">"http://{}/restartGateWay.json?sessionKey={}"</span>.<span style="color: #2c3e50;">format</span>(DEVICE_IP,
<span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>  session_id),
<span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span> <span style="color: #16a085;">"action=restartGateWay&amp;actionid=8"</span>)
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #3498db;">text</span> = response.text <span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">{ "status": "success", "actionid": "8" }</span>
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #3498db;">return_object</span> = response.json()
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #2c3e50; font-style: italic;">if</span> <span style="color: #16a085;">"success"</span> == return_object[<span style="color: #16a085;">"status"</span>]:
<span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="color: #2c3e50; font-style: italic;">print</span>(<span style="color: #16a085;">"Device rebooted successfully, wait a minute!"</span>)
<span style="background-color: #ecf0f1;"> </span>   <span style="color: #2c3e50; font-style: italic;">else</span>:
<span style="background-color: #ecf0f1;"> </span>   <span style="background-color: #ecf0f1;"> </span>   <span style="color: #2c3e50; font-style: italic;">print</span>(<span style="color: #16a085;">"Failed to reboot the device, return json: {}"</span>.<span style="color: #2c3e50;">format</span>(text))

<span style="color: #2c3e50; font-style: italic;">if</span> <span style="color: #2c3e50;">__name__</span> == <span style="color: #16a085;">'__main__'</span>:
<span style="background-color: #ecf0f1;"> </span>   reboot()
</pre>
</div>

<p>
此脚本依赖 Python Requests 库，可以通过 <code>pip</code> 来安装；我使用 Python3 ，不过 Python2 应该也不会有太大问题。
把上述脚本保存到文件中，比如 <code>~/bin/reboot-tianyi-gateway</code> ，并且增加可执行权限（ <code>chmod +x ~/bin/reboot-tianyi-gateway</code> ），在需要的时候在终端中执行 <code>~/bin/reboot-tianyi-gateway</code> 即可。 :)
</p>

<p>
另外，正如注释中提到的，其实 <code>/restartGateWay.json</code> 这个是一个裸接口，并没有校验 <code>sessionKey</code> 的有效性；甚至登录接口在用户登录之后也不会设置 cookie ，所有的业务接口都是可以直接调用的，也就是说，登录界面只是一个摆设。 :(
</p>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-python.html">Python</a> </div>
<div class="post-date">29 Sep 2019</div><h1 class="post-title"><a href="2019-09-29-how-to-run-the-bleeding-edge-code-of-qtile-within-virtualenv.html">How to run the bleeding-edge code of Qtile within a virtualenv</a></h1>
<p>
For having been using GNOME for quite a long time, I was considering trying some tiling window managers to see what it's like a few weeks ago. Along the way, I found a nice window manager written in Python: <a href="http://www.qtile.org">Qtile</a>, what interests me most is that it's a <b>hackable</b> window manager, which makes it flexible to extend or change its behaviors.
</p>

<p>
Well, switching to use a tiling window manager is far simpler than I thought. There are two ways to have it:
</p>
<ol class="org-ol">
<li>Installing it via the system's package manager, e.g. <code>dnf</code> for Fedora</li>
<li>Installing it from the source code repo.</li>
</ol>

<p>
If you just want to give it a try, you can just install it via a package manager, logout the current X session, and re-login with Qtile as your window manager (there are options when you log in), and you're done. It's that simple.
</p>

<p>
As Qtile is still under development, I would like to run the bleeding-edge source code to catch up with Qtile.
</p>

<p>
As in the <a href="http://docs.qtile.org/en/latest/manual/install/index.html#qtile">docs</a> , it's quite straight-forward to install it.
</p>

<div class="org-src-container">
<pre class="src src-shell">git clone git://github.com/qtile/qtile.git
<span style="color: #2c3e50;">cd</span> qtile
pip3 install .
</pre>
</div>

<p>
But it will pollute the environment, so I'd rather contain it within a virtualenv, here are the steps how to run it within a dedicated virtualenv for user <code>foo</code> on Fedora.
</p>

<ol class="org-ol">
<li><p>
Clone the repo
</p>

<div class="org-src-container">
<pre class="src src-shell">mkdir -p ~/local/
git clone https://github.com/qtile/qtile.git
</pre>
</div></li>

<li><p>
Create a new virtualenv, and install dependencies there
</p>

<div class="org-src-container">
<pre class="src src-shell">python3 -m venv ~/local/qtile/qtile-env/
<span style="color: #2c3e50;">source</span> ~/local/qtile/qtile-env/bin/activate

<span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">Install dependencies</span>
pip install xcffib
pip install --no-cache-dir cairocffi
</pre>
</div></li>

<li><p>
Make a glue shell script to use the virtualenv
</p>

<div class="org-src-container">
<pre class="src src-shell">cat &gt; /home/foo/local/qtile/qtile-venv-entry &lt;&lt;EOF
<span style="color: #16a085;">#!/bin/bash</span>

<span style="color: #16a085;"># This glue shell is only needed when you want to</span>
<span style="color: #16a085;"># run Qtile within a virtualenv</span>

<span style="color: #16a085;">source ~/local/qtile/qtile-env/bin/activate</span>
<span style="color: #16a085;">python ~/local/qtile/bin/qtile $*</span>
<span style="color: #16a085;">EOF</span>
</pre>
</div>

<p>
Also, make sure to make it executable, that is, <code>chmod +x /home/foo/local/qtile/qtile-venv-entry</code>
</p></li>

<li><p>
Make a entry desktop file for the display manager
</p>

<div class="org-src-container">
<pre class="src src-shell">cat &gt; /usr/share/xsessions/qtile-venv.desktop &lt;&lt;EOF
<span style="color: #16a085;">[Desktop Entry]</span>
<span style="color: #16a085;">Name=Qtile(venv)</span>
<span style="color: #16a085;">Comment=Qtile Session Within Venv</span>
<span style="color: #16a085;">Exec=/home/foo/local/qtile/qtile-venv-entry</span>
<span style="color: #16a085;">Type=Application</span>
<span style="color: #16a085;">Keywords=wm;tiling</span>
<span style="color: #16a085;">EOF</span>
</pre>
</div>

<p>
Pay attention to the <code>Exec</code> directive, it points to the glue script.
</p></li>

<li>Log out or reboot your system, then select “Qtile(venv)” as your window manager by clicking the setting icon when logging in.</li>
</ol>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-python.html">Python</a> </div>
<div class="post-date">24 Sep 2019</div><h1 class="post-title"><a href="2019-09-24-how-to-revert-a-series-of-commits-with-git.html">How to revert a series of commits with Git?</a></h1>
<p>
Sometimes, I need to revert a series of commits that are already pushed, doing a git hard reset is not an option, as someone may already have new commits based on mine.
</p>

<p>
For example, assume that I've made a few commits like below:
</p>

<pre class="example">
65a2c62 * commit 10
25cad43 * commit 9
72ad583 * commit 8
ceebf9a * commit 7
acf8a11 * commit 6
28d526f * commit 5
63af1e2 * commit 4
982c71c * commit 3
0fb4c2d * commit 2
acf9da1 * commit 1
b5f9933 * commit 0
</pre>

<p>
Now for whatever reason, I need to "drop" the changes made by commit 6 to commit 10, that is, go back to commit 5 without deleting commit.
</p>

<p>
How to do that?
</p>

<p>
One way is to use <code>git revert 28d526f..HEAD</code> to reversely revert the commits, which results in below commit history:
</p>

<pre class="example">
66808e5 * Revert "commit 6"
2661e48 * Revert "commit 7"
db86ec6 * Revert "commit 8"
fde9cb5 * Revert "commit 9"
3bf102f * Revert "commit 10"
65a2c62 * commit 10
25cad43 * commit 9
72ad583 * commit 8
ceebf9a * commit 7
acf8a11 * commit 6
28d526f * commit 5
63af1e2 * commit 4
982c71c * commit 3
0fb4c2d * commit 2
acf9da1 * commit 1
</pre>

<p>
It works, but it makes too many commits, in many cases that's not what I want, I'd rather make only one commit.
</p>

<p>
So is there a better way? The other day, I found the soft reset can suite my needs.
</p>

<p>
But how is it possible? Generally, <code>git reset</code> is used to move HEAD around the commits and/or to reset the index and working tree. The magic is that a soft reset can reset HEAD to a specific commit but leave the index and working tree untouched, so if I soft-reset HEAD from "commit 5" to "commit 10", it will move HEAD directly to "commit 10", but let the index as is, so that the index has the diff from "commit 10" to "commit 5" at the same time (<a href="https://davidzych.com/difference-between-git-reset-soft-mixed-and-hard/">Difference between git reset soft, mixed and hard - davidzych.com</a> illustrates different kinds of reset in detail.)
</p>

<p>
Here are the steps:
</p>
<div class="org-src-container">
<pre class="src src-shell">git branch master-bak    <span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">create a backup branch in case commits lost</span>
git reset --hard 28d526f <span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">the commit 5</span>
git reset --soft master-bak
git commit -m <span style="color: #16a085;">"Revert the commits [6,10]"</span>
git diff 28d526f..HEAD   <span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">confirm that it doesn't have any diffs</span>
</pre>
</div>

<p>
P.S. It's a bit boring to prepare git commits above, so I bake a helper script to do that:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #95a5a6; font-style: italic;">#</span><span style="color: #95a5a6; font-style: italic;">!/bin/</span><span style="color: #2c3e50; font-style: italic;">bash</span>

<span style="color: #3498db;">COUNT</span>=0
<span style="color: #3498db;">REPO</span>=<span style="color: #16a085;">""</span>
<span style="color: #2c3e50; font-style: italic;">if</span> [ $<span style="color: #3498db;">#</span> -ne 2 ]
<span style="color: #2c3e50; font-style: italic;">then</span>
    <span style="color: #2c3e50;">echo</span> <span style="color: #16a085;">"Usage: $0 &lt;REPO-DIR&gt; &lt;COUNT&gt;"</span>
    <span style="color: #2c3e50; font-style: italic;">exit</span> 1
<span style="color: #2c3e50; font-style: italic;">fi</span>
<span style="color: #3498db;">REPO</span>=$<span style="color: #3498db;">1</span>
<span style="color: #3498db;">COUNT</span>=$<span style="color: #3498db;">2</span>

<span style="color: #2c3e50;">echo</span> <span style="color: #16a085;">"Creating the repo and cd'ing into it..."</span>
mkdir -p $<span style="color: #3498db;">REPO</span> &amp;&amp; <span style="color: #2c3e50;">cd</span> $<span style="color: #3498db;">REPO</span>
[ ! -d .git/ ] &amp;&amp; git init .

<span style="color: #2c3e50;">echo</span> <span style="color: #16a085;">"Making commits..."</span>
<span style="color: #2c3e50; font-style: italic;">for</span> i<span style="color: #2c3e50; font-style: italic;"> in</span> <span style="color: #ff00ff;">`seq 0 $COUNT`</span>;
<span style="color: #2c3e50; font-style: italic;">do</span>
    <span style="color: #2c3e50;">echo</span> <span style="color: #16a085;">"modification made by commit $i"</span> &gt;&gt; demo.txt
    git add demo.txt
    git commit -m <span style="color: #16a085;">"commit $i"</span>
<span style="color: #2c3e50; font-style: italic;">done</span>
</pre>
</div>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-git.html">Git</a> </div>
<div class="post-date">18 Aug 2019</div><h1 class="post-title"><a href="2019-08-18-how-to-rename-web-page-titles-in-a-lightweight-way.html">How to rename web page titles in a lightweight way</a></h1>
<p>
There are times that I need to open many web pages of some specific websites within a browser, there are so many tabs that I can't efficiently access one of them, as their favicons are all the same.
</p>

<p>
So I tried to find a way to rename their titles, preferably in a lightweight way, so that I can spot them quickly with my eyes.
</p>

<p>
The first thought came into my mind was to find some extensions to do the job. It was easy to install one with no time. But I was not very happy with the experience. It seems that it keeps the rule of renaming titles based on the URL so that the title will always be renamed if I refreshing it, which is not what I want. I'd rather want to do it in an ad-hoc way.
</p>

<p>
Then I thought maybe it can be simply done with a bookmarklet, nevertheless, it's just a simple JavaScript statement of <code>document.title = "nice-title"</code>. With that in my mind, it didn't take me much time to write this bookmarklet:
</p>
<div class="org-src-container">
<pre class="src src-js">javascript:
(<span style="color: #2c3e50; font-style: italic;">function</span> ()
 {
     <span style="color: #2c3e50; font-style: italic;">var</span> <span style="color: #3498db;">title</span> = window.prompt(<span style="color: #16a085;">"Enter new title: "</span>, <span style="color: #16a085;">""</span>);
     <span style="color: #2c3e50; font-style: italic;">if</span> (title)
     {
         document.title= title;
     }
 })()
</pre>
</div>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-tools.html">Tools</a> </div><div id="archive">
<a href="archive.html">Other posts</a>
</div>
</div>
</body>
</html>

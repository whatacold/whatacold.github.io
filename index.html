<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://whatacold.github.io/rss.xml"
      title="RSS feed for https://whatacold.github.io/"/>
<title>whatacold's blog site</title>
<meta name="author" content="Guangwang Huang">
<meta name="referrer" content="no-referrer">
<link href= "static/style.css" rel="stylesheet" type="text/css" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-74588785-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-74588785-1');
</script>
</head>
<body>
<div id="preamble" class="status"><div class="header">
<div class="sitelinks">
    <a href="https://github.com/whatacold">GitHub</a> | <a href="https://stackoverflow.com/users/910978/whatacold">Stack Overflow</a> | <a href="mailto:whatacold@gmail.com">Email</a> | <a href="/rss.xml">RSS</a>
</div></div>
<div id="content">

<div class="post-date">21 Oct 2020</div><h1 class="post-title"><a href="2020-10-21-a-python-re.findall-service.html">A Python re.findall Service</a></h1>
<p>
As a programmer, I know that grep, sed and awk are powerful for processing text, but they sometimes aren't that straight-forward for specific tasks, as I need to think about how to filter the lines and the columns out. So I wonder if there is a handy way to do these tasks? After using it for a while, I think using regex directly can help, so I launched a <a href="https://texttoolkit.com/re.findall">re.findall service</a> building on top of Python <code>re.findall</code> API.
</p>

<p>
Here are some use cases for it.
</p>

<ol class="org-ol">
<li><p>
Find all words beginning with a specific prefix.
</p>

<p>
I have a few paragraphs, and I want to find out all words beginning with the letter 's'. Just a few steps:
</p>
<ol class="org-ol">
<li>Copy the text to the left input box.</li>
<li>Type in the regex: <code>\bs\w*</code>, and click the button.</li>
<li>The result will show in the right box.</li>
</ol></li>

<li><p>
Extract fields out.
</p>

<p>
It's not uncommon to extract some fields from some lines with a similar structure, such as a Protobuf message definition.
</p>

<p>
Imagine that I need to write a few test cases for a Protobuf-based service, and I have such a message (taken from the <a href="https://developers.google.com/protocol-buffers">Protocol Buffers</a> site) at hand:
</p>

<pre class="example">
message Person {
  required string Name = 1;
  required int32 Id = 2;
  optional string Email = 3;
}
</pre>

<p>
The final test case that I want looks like this (Note that the field names in the <code>set_xxx</code> form must be lower-case):
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #27ae60;">Person</span> <span style="color: #3498db;">person</span>;
person.set_name(<span style="color: #16a085;">"Text Toolkit"</span>);
person.set_id(1024);
person.set_email(<span style="color: #16a085;">"whatacold@gmail.com"</span>);
</pre>
</div>

<p>
The steps are the same as the above use case. Copy the message definition to the left input box and type <code>(\w+) =</code> in the regex box. It will give you the three field names as output, based on what I can quickly complete the test case with Emacs' help.
</p></li>

<li><p>
Find specific attributes in HTML/XML.
</p>

<p>
As a widely used configuration file format, I sometimes need to find out all value of a specific attribute in an XML file. HTML has a similar file syntax, so here I make an example from HTML. I now need to figure out what types of input I use in a specific HTML file for whatever reasons. How can I do that?
</p>

<p>
Simply copy and paste the HTML code, write a regex <code>&lt;input[^&lt;]+type="(\w+)"</code> in the box, and click the button. Want to deduplicate the result? Check the box "unique" and click the button again.
</p></li>
</ol>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-python.html">Python</a> <a href="tag-texttoolkit.html">texttoolkit</a> </div>
<div class="post-date">22 Aug 2020</div><h1 class="post-title"><a href="2020-08-22-generate-call-graphs-using-doxygen-in-emacs.html">Generate Call Graphs Using Doxygen in Emacs</a></h1>
<p>
<a href="https://www.doxygen.nl/">Doxygen</a> is a nice tool for generating documentations for well-annotated C/C++ projects, the one feature that I like most is generating call graphs and class diagrams, so that I can learn a project quickly by browsing the diagrams from a higher point of view.
</p>

<p>
I take the following steps to generate call graphs for a project on terminals on Linux:
</p>
<ol class="org-ol">
<li><code>cd /path/to/a/project/</code>, and generate a template config file by <code>doxygen -s -g doxygen.conf</code> (Omit <code>-s</code> to generate it with detailed comments).</li>
<li><p>
Tweak the file by specifying input and output directories, and set <code>HAVE_DOT</code> and <code>CALL_GRAPH</code> to <code>YES</code>.
</p>

<p>
Here is the complete diff:
</p>
<div class="org-src-container">
<pre class="src src-diff"><span style="color: #425d78; background-color: #dce0e1;">--- </span><span style="color: #425d78; background-color: #95a5a6; font-weight: bold;">doxygen.conf.orig</span>
<span style="color: #425d78; background-color: #dce0e1;">+++ </span><span style="color: #425d78; background-color: #95a5a6; font-weight: bold;">doxygen.conf</span>
<span style="color: #425d78; background-color: #dce0e1;">@@ -8,7 +8,7 @@</span>
<span style="color: #333333;"> PROJECT_NUMBER         =</span>
<span style="color: #333333;"> PROJECT_BRIEF          =</span>
<span style="color: #333333;"> PROJECT_LOGO           =</span>
<span style="color: #e74c3c;">-</span><span style="color: #e74c3c;">OUTPUT_DIRECTORY       =</span>
<span style="color: #3498db;">+</span><span style="color: #3498db;">OUTPUT_DIRECTORY       = /path/to/doxygen-output/</span>
<span style="color: #333333;"> CREATE_SUBDIRS         = NO</span>
<span style="color: #333333;"> ALLOW_UNICODE_NAMES    = NO</span>
<span style="color: #333333;"> OUTPUT_LANGUAGE        = English</span>
<span style="color: #425d78; background-color: #dce0e1;">@@ -114,7 +114,7 @@</span>
<span style="color: #333333;"> #---------------------------------------------------------------------------</span>
<span style="color: #333333;"> # Configuration options related to the input files</span>
<span style="color: #333333;"> #---------------------------------------------------------------------------</span>
<span style="color: #e74c3c;">-</span><span style="color: #e74c3c;">INPUT                  =</span>
<span style="color: #3498db;">+</span><span style="color: #3498db;">INPUT                  = /path/to/a/project/ # the directory of the source code</span>
<span style="color: #333333;"> INPUT_ENCODING         = UTF-8</span>
<span style="color: #333333;"> FILE_PATTERNS          = *.c \</span>
<span style="color: #333333;">                          *.cc \</span>
<span style="color: #425d78; background-color: #dce0e1;">@@ -161,7 +161,7 @@</span>
<span style="color: #333333;">                          *.ucf \</span>
<span style="color: #333333;">                          *.qsf \</span>
<span style="color: #333333;">                          *.ice</span>
<span style="color: #e74c3c;">-</span><span style="color: #e74c3c;">RECURSIVE              = NO</span>
<span style="color: #3498db;">+</span><span style="color: #3498db;">RECURSIVE              = YES</span>
<span style="color: #333333;"> EXCLUDE                =</span>
<span style="color: #333333;"> EXCLUDE_SYMLINKS       = NO</span>
<span style="color: #333333;"> EXCLUDE_PATTERNS       =</span>
<span style="color: #425d78; background-color: #dce0e1;">@@ -255,7 +255,7 @@</span>
<span style="color: #333333;"> #---------------------------------------------------------------------------</span>
<span style="color: #333333;"> # Configuration options related to the LaTeX output</span>
<span style="color: #333333;"> #---------------------------------------------------------------------------</span>
<span style="color: #e74c3c;">-</span><span style="color: #e74c3c;">GENERATE_LATEX         = YES</span>
<span style="color: #3498db;">+</span><span style="color: #3498db;">GENERATE_LATEX         = NO</span>
<span style="color: #333333;"> LATEX_OUTPUT           = latex</span>
<span style="color: #333333;"> LATEX_CMD_NAME         =</span>
<span style="color: #333333;"> MAKEINDEX_CMD_NAME     = makeindex</span>
<span style="color: #425d78; background-color: #dce0e1;">@@ -345,10 +345,10 @@</span>
<span style="color: #333333;"> MSCGEN_PATH            =</span>
<span style="color: #333333;"> DIA_PATH               =</span>
<span style="color: #333333;"> HIDE_UNDOC_RELATIONS   = YES</span>
<span style="color: #e74c3c;">-</span><span style="color: #e74c3c;">HAVE_DOT               = NO</span>
<span style="color: #3498db;">+</span><span style="color: #3498db;">HAVE_DOT               = YES</span>
<span style="color: #333333;"> DOT_NUM_THREADS        = 0</span>
<span style="color: #333333;"> DOT_FONTNAME           = Helvetica</span>
<span style="color: #e74c3c;">-</span><span style="color: #e74c3c;">DOT_FONTSIZE           = 10</span>
<span style="color: #3498db;">+</span><span style="color: #3498db;">DOT_FONTSIZE           = 14</span>
<span style="color: #333333;"> DOT_FONTPATH           =</span>
<span style="color: #333333;"> CLASS_GRAPH            = YES</span>
<span style="color: #333333;"> COLLABORATION_GRAPH    = YES</span>
<span style="color: #425d78; background-color: #dce0e1;">@@ -358,7 +358,7 @@</span>
<span style="color: #333333;"> TEMPLATE_RELATIONS     = NO</span>
<span style="color: #333333;"> INCLUDE_GRAPH          = YES</span>
<span style="color: #333333;"> INCLUDED_BY_GRAPH      = YES</span>
<span style="color: #e74c3c;">-</span><span style="color: #e74c3c;">CALL_GRAPH             = NO</span>
<span style="color: #3498db;">+</span><span style="color: #3498db;">CALL_GRAPH             = YES</span>
<span style="color: #333333;"> CALLER_GRAPH           = NO</span>
<span style="color: #333333;"> GRAPHICAL_HIERARCHY    = YES</span>
<span style="color: #333333;"> DIRECTORY_GRAPH        = YES</span>

</pre>
</div></li>

<li>Run <code>doxygen doxygen.conf</code>, that's it.</li>
</ol>

<p>
It's a bit boring to do this for every project, and let's improve the workflow a bit by using <a href="https://joaotavora.github.io/yasnippet/index.html">yasnippet</a> and making a new Emacs command.
</p>

<p>
First, make a new config template snippet with 3 placeholders (Set <code>yas-indent-line</code> to avoid reindention by yasnippet):
</p>
<pre class="example">
# -*- mode: snippet -*-
# expand-env: ((yas-indent-line 'never))
# --
# Doxyfile 1.8.15

PROJECT_NAME           = "${1:my-cool-project}"
...
OUTPUT_DIRECTORY       = ${2:`(format "%s/doxygen/" (expand-file-name "~"))`$1}
...
INPUT                  = $3 # XXX must be an absolute path
</pre>

<p>
With this snippet (see the exact file <a href="https://github.com/whatacold/emacs.d/blob/whatacold/snippets/conf-unix-mode/doxygen.yasnippet">here</a>), I can quickly create a doxygen config for a project by "finding" a new file and insert the snippet by <code>M-x yas-insert-snippet</code>.
</p>

<p>
Second, make a helper command to run doxygen quickly with a projects buffer as the current buffer of Emacs:
</p>
<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #2c3e50; font-style: italic;">defun</span> <span style="color: #9b59b6;">w/run-doxygen</span> ()
  <span style="color: #16a085;">"Run doxygen asynchronously."</span>
  (<span style="color: #2c3e50; font-style: italic;">interactive</span>)
  (<span style="color: #2c3e50; font-style: italic;">let</span> ((conf (locate-dominating-file default-directory <span style="color: #16a085;">"doxygen.conf"</span>)))
    (<span style="color: #2c3e50; font-style: italic;">if</span> (not conf)
        (message <span style="color: #16a085;">"No doxygen.conf found!"</span>)
      (shell-command (format <span style="color: #16a085;">"doxygen %sdoxygen.conf&amp;"</span> conf)))))
</pre>
</div>

<p>
This time, just type <code>M-x w/run-doxygen</code> to generate call graphs in Emacs.
</p>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-emacs.html">Emacs</a> </div>
<div class="post-date">25 Jun 2020</div><h1 class="post-title"><a href="2020-06-25-is-it-safe-to-use-redis-as-a-data-store.html">Is it safe to use Redis as a data store?</a></h1>
<p>
Traditionally we are used to storing data in an RDBMS like MySQL, and avoid using in-memory solutions such as Redis, to have a confidence of no data loss. Sometimes I find that we are so stubborn with MySQL that ending up with a complicated design, and I've even seen a solution that stores data in MySQL and then using Redis as a cache for it to improve read performance in the meanwhile. And to make the data in the cache as consistent as possible with the data in MySQL, it introduces other mechanisms, but the result is still not 100% consistent.
</p>

<p>
So I wonder, is it safe to use Redis as a data store directly? Since if that's OK, we can have a clean solution without using MySQL for, at least, the above scenario.
</p>

<p>
Redis has two data <a href="https://redis.io/topics/persistence">persistence</a> solutions: the RDB persistence and AOF persistence. The RDB persistence is suitable for making complete point-in-time backups every a few minutes, which can be configured via the <code>save</code> directive. And the AOF persistence is finer-grained, as it logs every command that it executes, and there are three options for how frequent it flushes (<code>[[https://man7.org/linux/man-pages/man2/fsync.2.html][fsync]]</code>'ing in the syscall level) the AOF file to the disk (the <code>appendfsync</code> option):
</p>

<ul class="org-ul">
<li>always: <code>fsync</code> every time a new command is appended to the AOF.</li>
<li>everysec: <code>fsync</code> every second.</li>
<li>no: Never <code>fsync</code>, it's up to the OS when to fsync the file.</li>
</ul>

<p>
So the answer is yes, for a situation that Redis is more suitable to organize the data in a NoSQL style. Use <code>always</code> for <code>appendfsync</code> if we can't tolerate any data loss, and use <code>everysec</code> if the data is not that important, and we can endure a second of data loss, at most.
</p>

<p>
As a comparison, MySQL has a similar mechanism called binary log (binlog) to log its SQL statements, and there is also a configuration directive, <a href="https://dev.mysql.com/doc/refman/5.7/en/replication-options-binary-log.html#sysvar_sync_binlog">sync_binlog</a>, to control how often it <code>fsync</code>'s:
</p>
<ul class="org-ul">
<li>0, never <code>fsync</code> explicitly</li>
<li>1, <code>fsync</code> every statement</li>
<li>N (N&gt;1), <code>fsync</code> every N statements</li>
</ul>

<p>
So it's OK to use Redis as a data store with the AOF persistence enabled, it can be as safe as MySQL in theory.
</p>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-redis.html">Redis</a> <a href="tag-mysql.html">MySQL</a> </div>
<div class="post-date">30 May 2020</div><h1 class="post-title"><a href="2020-05-30-a-trick-to-troubleshoot-emacs-subprocess-creating.html">A Trick to Troubleshoot Emacs Subprocess Creating</a></h1>
<p>
There are many packages of Emacs that leverage subprocesses to do their jobs, <a href="https://magit.vc/">Magit</a>, <a href="https://github.com/joaotavora/eglot">eglot</a>, <a href="https://github.com/jorgenschaefer/elpy">elpy</a>, to name a few. And there are times that a subprocess doesn't work as expected, for example, Magit is slow, and you're sure that it's ok when running git commands on shell. So how to spot these problems effectively and quickly?
</p>

<p>
The problem is that we don't know what's going on exactly, so here I want to share a few Elisp advice to make the subprocess creating visible, and print the exact program and its arguments to the <code>*Message*</code> buffer. Visibility is the key.
</p>

<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #2c3e50; font-style: italic;">defvar</span> <span style="color: #3498db;">trace-subprocess-p</span> nil
  <span style="color: #16a085;">"Whether to trace subprocess creating or not."</span>)

(<span style="color: #2c3e50; font-style: italic;">defun</span> <span style="color: #9b59b6;">my-toggle-trace-subprocess</span> ()
  <span style="color: #16a085;">"Toggle whether to trace subprocess creating."</span>
  (<span style="color: #2c3e50; font-style: italic;">interactive</span>)
  (<span style="color: #2c3e50; font-style: italic;">setq</span> trace-subprocess-p (not trace-subprocess-p))
  (<span style="color: #2c3e50; font-style: italic;">when</span> trace-subprocess-p
    (message <span style="color: #16a085;">"Trace subprocess creating."</span>)))

(<span style="color: #2c3e50; font-style: italic;">defun</span> <span style="color: #9b59b6;">my-quote-argument</span> (arg)
  <span style="color: #16a085;">"Double quote ARG."</span>
  (concat <span style="color: #16a085;">"\""</span> arg <span style="color: #16a085;">"\""</span>))

(<span style="color: #2c3e50; font-style: italic;">define-advice</span> <span style="color: #9b59b6;">start-process</span> (<span style="color: #2c3e50;">:before</span> (name buffer program <span style="color: #27ae60;">&amp;rest</span> program-args) trace)
  (<span style="color: #2c3e50; font-style: italic;">when</span> trace-subprocess-p
    (message <span style="color: #16a085;">"Trace start-process: name: %s, buffer: %s, program and args: %s %s"</span>
             name buffer program
             (mapconcat #'my-quote-argument program-args <span style="color: #16a085;">" "</span>))))

(<span style="color: #2c3e50; font-style: italic;">define-advice</span> <span style="color: #9b59b6;">shell-command-to-string</span> (<span style="color: #2c3e50;">:before</span> (command) trace)
  (<span style="color: #2c3e50; font-style: italic;">when</span> trace-subprocess-p
    (message <span style="color: #16a085;">"Trace shell-command-to-string: %s"</span> command)))

(<span style="color: #2c3e50; font-style: italic;">define-advice</span> <span style="color: #9b59b6;">call-process</span> (<span style="color: #2c3e50;">:before</span> (program <span style="color: #27ae60;">&amp;optional</span> infile destination display <span style="color: #27ae60;">&amp;rest</span> args) trace)
  (<span style="color: #2c3e50; font-style: italic;">when</span> trace-subprocess-p
    (message <span style="color: #16a085;">"Trace call-process: %s %s"</span>
             program
             (mapconcat #'my-quote-argument args <span style="color: #16a085;">" "</span>))))
</pre>
</div>

<p>
Add these to your <code>.emacs.d</code> and type <code>M-x my-toggle-trace-subprocess RET</code> when you want to see what is going on under the neath. The following is how it looks like when I run <code>M-x elpy-mode</code> on a Python buffer:
</p>

<pre class="example">
Trace start-process: name:  *elpy-rpc [project:~/python/qtile/ environment:/home/whatacold/virtualenv/elpy]*, buffer:  *elpy-rpc [project:~/python/qtile/ environment:/home/whatacold/virtualenv/elpy]*, program and args: /home/whatacold/.emacs.d/elpy/rpc-venv/bin/python "-W" "ignore" "-m" "elpy.__main__"
</pre>

<p>
With the help of these advice, I successfully resolved a performance issue of Magit with a particular repo the other day, which was caused by <a href="https://github.com/emacsorphanage/magit-svn">magit-svn</a> hooks.
</p>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-emacs.html">Emacs</a> <a href="tag-troubleshooting.html">troubleshooting</a> </div>
<div class="post-date">11 Apr 2020</div><h1 class="post-title"><a href="2020-04-11-use-ppcompile-to-remote-compile-in-emacs-zh.html">Emacs 中使用 ppcompile 进行远程编译</a></h1>
<p>
不同于 Python 之类的项目， C/C++ 的项目需要有专门的编译环境，一般国内公司都会搭建特定的编译环境机器，把一些私有的库等依赖放在上面。而这些编译环境的工具链一般都比较老旧，有的编译环境可能还无法访问外网，甚至也没有提供代理间接访问外网。因此想要在这样的环境中使用 Emacs 开发代码着实不是一件容易的事。
</p>

<p>
一个可行的方法是在自己的工作机器上维护一个开发环境跑 Emacs ，需要编译的时候把代码同步到编译机器（使用 sshfs 、 sftp 等），编译过程中发现的编译问题，在本地修复好之后，再次同步，如此往复。
</p>

<p>
但是有一个问题，整个流程太过繁琐，需要不停地手工同步。即使像 sshfs 这样无须同步的方式，在本地编辑时偶尔卡顿会比较明显。最让人无法接受的是，在修复编译的过程中，需要手工定位到具体的文件及行数，繁琐而且效率低。
</p>

<p>
你可能会说为什么不用 Tramp 模式直接在远端的编译环境中直接编辑文件呢？的确， Tramp 编辑代码没有问题，体验也挺流畅的，但它无法解决你无法自由控制远端环境这个缺点，比如你想集成 <code>ag/rg</code> 到 Emacs 中，光安装程序可能就很折腾；而且如果公司有多套编译环境时，每个环境都维护 Emacs 会是一个麻烦。
</p>

<p>
经过一段时间的摸索，我感觉自己还是比较喜欢在本地编辑然后同步代码编译这种方式，这个过程可以自动化。另外很重要的一点需求是，它需要能够像 <code>M-x compile</code> 那样在 Emacs 中很方便地使用 <code>M-x next-error</code> and <code>M-x previous-error</code> 来自动定位编译有问题的代码行，这样不仅提高修复编译错误的效率，还能保护视力。
</p>

<p>
按照上述思路我最终写了这样一个小插件 <a href="https://github.com/whatacold/ppcompile">ppcompile</a> ， pp 二字代表 ping-pong ，表示每次编译就像打乒乓球一样。本地先发球，利用 rsync 把代码同步到远端，远端编译之后回球，然后本地再转换 <code>*compilation*</code> buffer 中远端的路径，这样 Emacs 就能够正确地识别编译错误，从而帮助我直接打开对应的错误文件及行数。
</p>

<p>
使用方式上，只需要把 <code>ppcompile.el</code> 拷贝到 load-path 中进行加载，然后设置一些选项即可。具体可以参考项目 README 。当前提供以下几个命令：
</p>
<ol class="org-ol">
<li><code>ppcompile-ping</code> 仅同步代码到远端</li>
<li><code>ppcompile-pong</code> 仅在远端编译</li>
<li><p>
<code>ppcompile</code> 同步代码以及编译，即一次 ping-pong 往返。
</p>

<p>
这个命令和 <code>ppcompile-pong</code> 命令在使用上同时考虑了 compile 命令的使用习惯，会遵循你的 <code>compilation-read-command</code> 设置决定是否编译时弹窗让你选择编译命令。
</p></li>

<li><code>ppcompile-config-project</code> 配置项目配置到根目录的 <code>.dir-locals.el</code> 中，主要是为了方便有很多项目时的个性化定制需求，否则直接配置全局的就可以了。</li>

<li><code>ppcompile-toggle-debug</code> 调试开关命令，在开启的情况下会把当前执行的命令行打印到 <code>*Message*</code> 中。</li>
</ol>

<p>
目前，我自己使用 ppcompile 已经没有什么问题了，它在最近的项目开发中帮我节省了不少精力，欢迎大家试用和使用 :)
</p>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-emacs.html">emacs</a> <a href="tag-zhongwen.html">zhongwen</a> </div><div id="archive">
<a href="archive.html">Other posts</a>
</div>
</div>
</body>
</html>

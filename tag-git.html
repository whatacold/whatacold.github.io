<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://whatacold.github.io/rss.xml"
      title="RSS feed for https://whatacold.github.io/"/>
<title>whatacold's blog site</title>
<meta name="author" content="Guangwang Huang">
<meta name="referrer" content="no-referrer">
<link href= "static/style.css" rel="stylesheet" type="text/css" /></head>
<body>
<div id="preamble" class="status"><div class="header">
<div class="sitelinks">
    <a href="https://github.com/whatacold">GitHub</a> | <a href="https://stackoverflow.com/users/910978/whatacold">Stack Overflow</a> | <a href="mailto:whatacold@gmail.com">Email</a> | <a href="/rss.xml">RSS</a>
</div></div>
<div id="content">
<h1 class="title">Posts tagged "Git":</h1>
<div class="post-date">01 Dec 2019</div><h1 class="post-title"><a href="2019-12-01-why-can't-git-fetch-remote-branches-other-than-master.html">Why can't Git fetch remote branches other than master?</a></h1>
<p>
Last week I came into a problem with Git, that I can't fetch the remote branch that I pushed to. It was so weird because I can push the local branch there. It never happens before, and it happened when I was in a rush to rebase my code, as someone in my team pushed his code.
</p>

<p>
After searching, it seemed that the configuration of <code>fetch</code> of that repo was different(this <a href="https://stackoverflow.com/questions/11623862/fetch-in-git-doesnt-get-all-branches">Stack Overflow</a> thread for example) than before, it was specified that only <code>master</code> can be fetched. It worked after I changed it to <code>+refs/heads/*:refs/remotes/origin/*</code>.
</p>

<p>
I reflected why it happened after work, the only difference I can remember was that I clone that repo with the option <code>--depth &lt;N&gt;</code>, that is, it was a shallow clone to save disk space.
</p>

<p>
Today I had some time at hand, and I confirmed that the option is the problem by reading the git-clone(1) manpage, it notes that:
</p>
<pre class="example">
--depth &lt;depth&gt;
    Create a shallow clone with a history truncated to the specified number of commits. Implies --single-branch unless
    --no-single-branch is given to fetch the histories near the tips of all branches.
</pre>

<p>
Let's demonstrate it by cloning my dotfiles repo with different options, and it shows clearly that Git will only fetch <code>master</code> of the remote repo if only specifying <code>--depth</code>:
</p>

<div class="org-src-container">
<pre class="src src-shell">$ cd /tmp/
$ git clone --depth 1 https://github.com/whatacold/dotfiles.git dotfiles-depth1
$ git clone --no-single-branch --depth 1 https://github.com/whatacold/dotfiles.git dotfiles-no-single-branch
$ git clone https://github.com/whatacold/dotfiles.git dotfiles-full

$ grep <span style="color: #16a085;">'remote "origin"'</span> -A 2 dotfiles-depth1/.git/config 
[remote <span style="color: #16a085;">"origin"</span>]
    <span style="color: #3498db;">url</span> = https://github.com/whatacold/dotfiles.git
    <span style="color: #3498db;">fetch</span> = +refs/heads/master:refs/remotes/origin/master

$ grep <span style="color: #16a085;">'remote "origin"'</span> -A 2 dotfiles-no-single-branch/.git/config 
[remote <span style="color: #16a085;">"origin"</span>]
    <span style="color: #3498db;">url</span> = https://github.com/whatacold/dotfiles.git
    <span style="color: #3498db;">fetch</span> = +refs/heads/*:refs/remotes/origin/*

$ grep <span style="color: #16a085;">'remote "origin"'</span> -A 2 dotfiles-full/.git/config
[remote <span style="color: #16a085;">"origin"</span>]
    <span style="color: #3498db;">url</span> = https://github.com/whatacold/dotfiles.git
    <span style="color: #3498db;">fetch</span> = +refs/heads/*:refs/remotes/origin/*
</pre>
</div>

<p>
I don't know why <code>--single-branch</code> should be implied by default, at least for me, I just want to fetch all the remote branches.
</p>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-git.html">Git</a> </div>
<div class="post-date">24 Sep 2019</div><h1 class="post-title"><a href="2019-09-24-how-to-revert-a-series-of-commits-with-git.html">How to revert a series of commits with Git?</a></h1>
<p>
Sometimes, I need to revert a series of commits that are already pushed, doing a git hard reset is not an option, as someone may already have new commits based on mine.
</p>

<p>
For example, assume that I've made a few commits like below:
</p>

<pre class="example">
65a2c62 * commit 10
25cad43 * commit 9
72ad583 * commit 8
ceebf9a * commit 7
acf8a11 * commit 6
28d526f * commit 5
63af1e2 * commit 4
982c71c * commit 3
0fb4c2d * commit 2
acf9da1 * commit 1
b5f9933 * commit 0
</pre>

<p>
Now for whatever reason, I need to "drop" the changes made by commit 6 to commit 10, that is, go back to commit 5 without deleting commit.
</p>

<p>
How to do that?
</p>

<p>
One way is to use <code>git revert 28d526f..HEAD</code> to reversely revert the commits, which results in below commit history:
</p>

<pre class="example">
66808e5 * Revert "commit 6"
2661e48 * Revert "commit 7"
db86ec6 * Revert "commit 8"
fde9cb5 * Revert "commit 9"
3bf102f * Revert "commit 10"
65a2c62 * commit 10
25cad43 * commit 9
72ad583 * commit 8
ceebf9a * commit 7
acf8a11 * commit 6
28d526f * commit 5
63af1e2 * commit 4
982c71c * commit 3
0fb4c2d * commit 2
acf9da1 * commit 1
</pre>

<p>
It works, but it makes too many commits, in many cases that's not what I want, I'd rather make only one commit.
</p>

<p>
So is there a better way? The other day, I found the soft reset can suite my needs.
</p>

<p>
But how is it possible? Generally, <code>git reset</code> is used to move HEAD around the commits and/or to reset the index and working tree. The magic is that a soft reset can reset HEAD to a specific commit but leave the index and working tree untouched, so if I soft-reset HEAD from "commit 5" to "commit 10", it will move HEAD directly to "commit 10", but let the index as is, so that the index has the diff from "commit 10" to "commit 5" at the same time (<a href="https://davidzych.com/difference-between-git-reset-soft-mixed-and-hard/">Difference between git reset soft, mixed and hard - davidzych.com</a> illustrates different kinds of reset in detail.)
</p>

<p>
Here are the steps:
</p>
<div class="org-src-container">
<pre class="src src-shell">git branch master-bak    <span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">create a backup branch in case commits lost</span>
git reset --hard 28d526f <span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">the commit 5</span>
git reset --soft master-bak
git commit -m <span style="color: #16a085;">"Revert the commits [6,10]"</span>
git diff 28d526f..HEAD   <span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">confirm that it doesn't have any diffs</span>
</pre>
</div>

<p>
P.S. It's a bit boring to prepare git commits above, so I bake a helper script to do that:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #95a5a6; font-style: italic;">#</span><span style="color: #95a5a6; font-style: italic;">!/bin/</span><span style="color: #2c3e50; font-style: italic;">bash</span>

<span style="color: #3498db;">COUNT</span>=0
<span style="color: #3498db;">REPO</span>=<span style="color: #16a085;">""</span>
<span style="color: #2c3e50; font-style: italic;">if</span> [ $<span style="color: #3498db;">#</span> -ne 2 ]
<span style="color: #2c3e50; font-style: italic;">then</span>
    <span style="color: #2c3e50;">echo</span> <span style="color: #16a085;">"Usage: $0 &lt;REPO-DIR&gt; &lt;COUNT&gt;"</span>
    <span style="color: #2c3e50; font-style: italic;">exit</span> 1
<span style="color: #2c3e50; font-style: italic;">fi</span>
<span style="color: #3498db;">REPO</span>=$<span style="color: #3498db;">1</span>
<span style="color: #3498db;">COUNT</span>=$<span style="color: #3498db;">2</span>

<span style="color: #2c3e50;">echo</span> <span style="color: #16a085;">"Creating the repo and cd'ing into it..."</span>
mkdir -p $<span style="color: #3498db;">REPO</span> &amp;&amp; <span style="color: #2c3e50;">cd</span> $<span style="color: #3498db;">REPO</span>
[ ! -d .git/ ] &amp;&amp; git init .

<span style="color: #2c3e50;">echo</span> <span style="color: #16a085;">"Making commits..."</span>
<span style="color: #2c3e50; font-style: italic;">for</span> i<span style="color: #2c3e50; font-style: italic;"> in</span> <span style="color: #ff00ff;">`seq 0 $COUNT`</span>;
<span style="color: #2c3e50; font-style: italic;">do</span>
    <span style="color: #2c3e50;">echo</span> <span style="color: #16a085;">"modification made by commit $i"</span> &gt;&gt; demo.txt
    git add demo.txt
    git commit -m <span style="color: #16a085;">"commit $i"</span>
<span style="color: #2c3e50; font-style: italic;">done</span>
</pre>
</div>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-git.html">Git</a> </div>
<div class="post-date">17 Feb 2019</div><h1 class="post-title"><a href="2019-01-13-understand-git-submodule.html">如何理解 Git submodule</a></h1>
<p>
Git 虽然很强大，但也有少数命令很难理解。
submodule 就是这么一个例子，其文档教程也不少，比如 <a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules">Git - Submodules - git-scm.com</a> ，
但我之前始终没有真正领悟到如何使用。
</p>

<p>
直到有天看了一条  <a href="https://stackoverflow.com/a/5814351/910978">StackOverflow Answer</a> ，茅塞顿开，才真正理解了 submodule 。
</p>

<p>
submodule 涉及到两个仓库类型：
</p>
<dl class="org-dl">
<dt>submodule</dt><dd>子模块，比如需要使用的第三方库</dd>
<dt>superproject</dt><dd>主仓库，自己的工程，依赖子模块代码</dd>
</dl>

<p>
Git submodule 本质上是两个独立的仓库，各自可以独立地像普通的 repo 一样操作。
同时 superproject 有一个“指针”，记录了它使用的子模块的 commit revision 。
这个“指针”对于从 SVN 转过来的同学来说会比较不适应，因为 SVN External 没有这个设计，
所以 SVN 无法精确控制所使用的子模块 revision  ，更新主仓库时会自动更新其“子模块”的代码为最新的，
如果“子模块”是外部的代码并且不稳定的话，会影响自己的代码。
</p>

<p>
带着这个认知，在 superproject 中更新 submodule 的操作步骤示意如下：
<img src="./images/2019-01-13-git-submodule-diagram.png" alt="2019-01-13-git-submodule-diagram.png">
</p>

<p>
无论是 superproject 还是 submodule ，都像普通的 repo 一样进行 branch, add, push, diff 等等的操作，
只是最后再通过 <code>git submodule</code> 命令再更新下新“指针”位置即可。</p>
<div class="taglist"><a href="tags.html">Tags:</a> <a href="tag-git.html">Git</a> </div><div id="archive">
<a href="archive.html">Other posts</a>
</div>
</div>
</body>
</html>

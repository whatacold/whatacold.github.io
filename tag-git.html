<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://whatacold.github.io/rss.xml"
      title="RSS feed for https://whatacold.github.io/">
<title>whatacold's blog site</title>
<meta name="author" content="Guangwang Huang">
<meta name="referrer" content="no-referrer">
<link href= "static/style.css" rel="stylesheet" type="text/css" />

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-74588785-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-74588785-1');
</script>
</head>
<body>
<div id="preamble" class="status"><div class="header">
<div class="sitelinks">
    <a href="https://github.com/whatacold">GitHub</a> | <a href="https://stackoverflow.com/users/910978/whatacold">Stack Overflow</a> | <a href="mailto:whatacold@gmail.com">Email</a> | <a href="/rss.xml">RSS</a>
</div></div>
<div id="content">
<h1 class="title">Posts tagged "Git":</h1>
<div class="post-date">04 Feb 2020</div><h1 class="post-title"><a href="https://whatacold.github.io/2020-02-04-binary-search-algorithm-vs-problem-solving.html">The binary search algorithm is also an efficient strategy for narrowing down problem space</a></h1>
<p>
<a href="https://en.wikipedia.org/wiki/Binary_search_algorithm">Binary search algorithm</a> is a search algorithm that finds the position of a target value within a sorted array. It cuts off the target array in half in a pass, so that it has a worst-case performance of <code>O(log n)</code>.
</p>


<figure>
<object type="image/svg+xml" data="https://upload.wikimedia.org/wikipedia/commons/8/83/Binary_Search_Depiction.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>

<figcaption><span class="figure-number">Figure 1: </span>Visualization of the binary search algorithm where 7 is the target value(@wikipedia)</figcaption>
</figure>

<p>
We all know that it's an efficient searching algorithm, but the strategy behind it also applies for narrowing down other problem space, for example, finding out when a bug is first introduced in a series of git commits.
</p>

<p>
Let's say I have a git repo of 8 commits, the first 5 of which are good, but then the 6th commit introduces a bug, so I have a git commit history looks like below:
</p>
<pre class="example">
 |g|g|g|g|g|b|b|b|
---------------------&gt; the git commit history
</pre>

<p>
So I know that the first commit is good and the last (8th) commit is bad (these are initial problem space), by leveraging the strategy of binary search, it can quickly find out that the 6th commit is the first bad commit. (Check the 4th element first, then the 6th.)
</p>

<p>
Well, that's basically how <code>git bisect</code> works, and it's more powerful, it can be run with a script to determine if current commit is good or not, saving time to verify it manually.
</p>

<p>
Recently, I managed to use <code>git bisect</code> to find out a recession bug <a href="https://github.com/qtile/qtile/issues/1410">(#1410)</a> of qtile, which reports that <code>qtile-cmd</code> doesn't work anymore which the HEAD commit (<code>0617235c</code>), but it works with tag <code>v0.14.2</code>.
</p>

<p>
With those in mind, here are the steps to catch the first bad commit:
</p>
<ol class="org-ol">
<li><p>
Start the bisect session: <code>git bisect start 0617235c v0.14.2</code>
</p>

<pre class="example">
$ git bisect start 0617235c v0.14.2
Bisecting: 88 revisions left to test after this (roughly 7 steps)
[082e4c7248ac40b69dbe94cfdc4de6aecc5f74ba] Fix debian version
</pre></li>

<li><p>
Make a judge script(attached at the end) and find out the commit by running <code>git bisect run ./scripts/git-bisect-judge</code>
</p>

<p>
It only takes git 6 steps to find the first broken commit, the output is following with qtile logs being removed:
</p>
<pre class="example">
$ git bisect run ./scripts/git-bisect-judge
running ./scripts/git-bisect-judge
Bisecting: 44 revisions left to test after this (roughly 6 steps)
[fdb3a324aadb0f934080a703d6835a9a7d203720] Delay power renormalization
running ./scripts/git-bisect-judge
...

Bisecting: 21 revisions left to test after this (roughly 5 steps)
[0262fbc2ca23d27fa33c4903d7e8a9b8c14d42eb] Move around modules
running ./scripts/git-bisect-judge
...

Bisecting: 10 revisions left to test after this (roughly 4 steps)
[a3ae3c623859b247813fc1876b188c4d40e84df0] Move calls out of the command graph
running ./scripts/git-bisect-judge
...

Bisecting: 5 revisions left to test after this (roughly 3 steps)
[036dbcb1b7c5c0fff00fbfbb9688597e2d2f188c] Add tests to the command graph
running ./scripts/git-bisect-judge
...

Bisecting: 2 revisions left to test after this (roughly 1 step)
[9c3c78ca66905b4e11bfd7a155cfe883cbe12ad6] Create new command graph
running ./scripts/git-bisect-judge
...

Bisecting: 0 revisions left to test after this (roughly 0 steps)
[ed5eefbf3482481c1f0f4c1cb2eb79e571fec835] Use correct type annotations in IPC module
running ./scripts/git-bisect-judge
...

ed5eefbf3482481c1f0f4c1cb2eb79e571fec835 is the first bad commit
commit ed5eefbf3482481c1f0f4c1cb2eb79e571fec835
Author: Sean Vig &lt;sean.v.775@gmail.com&gt;
Date:   Wed Jun 19 22:33:45 2019 -0400

    Use correct type annotations in IPC module

    With python/typeshed#3061 making it into the most recent release of
    mypy, remove the hacks on the type annotations around the marshal
    module.

:040000 040000 d21cc05b503a0f4658647adad3169efbd84eaa16 f80f29304abd86da9299dfaf22f6719698a37e63 M	libqtile
bisect run success
</pre></li>

<li>End the session by running <code>git bisect reset</code>, git will restores your previouse HEAD commit.</li>
</ol>

<p>
The judge script <code>git-bisect-judege</code> is below:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #95a5a6; font-style: italic;">#</span><span style="color: #95a5a6; font-style: italic;">!/bin/</span><span style="color: #2c3e50; font-style: italic;">sh</span>

<span style="color: #3498db;">HERE</span>=$(dirname $(readlink -f $<span style="color: #3498db;">0</span>))
<span style="color: #3498db;">SCREEN_SIZE</span>=${<span style="color: #3498db;">SCREEN_SIZE</span>:-1000x800}
<span style="color: #3498db;">XDISPLAY</span>=${<span style="color: #3498db;">XDISPLAY</span>:-:1}
<span style="color: #3498db;">LOG_LEVEL</span>=${<span style="color: #3498db;">LOG_LEVEL</span>:-DEBUG}
<span style="color: #3498db;">LOG_LEVEL</span>=INFO
<span style="color: #2c3e50; font-style: italic;">if</span> [[ -z $<span style="color: #3498db;">PYTHON</span> ]]; <span style="color: #2c3e50; font-style: italic;">then</span>
    <span style="color: #3498db;">PYTHON</span>=python
<span style="color: #2c3e50; font-style: italic;">fi</span>

./scripts/ffibuild

<span style="color: #3498db;">CLIENT</span>=<span style="color: #16a085;">"urxvt"</span>

Xephyr +extension RANDR -screen ${<span style="color: #3498db;">SCREEN_SIZE</span>} ${<span style="color: #3498db;">XDISPLAY</span>} -ac &amp;
<span style="color: #3498db;">XEPHYR_PID</span>=$<span style="color: #3498db;">!</span>
sleep 0.5
<span style="color: #2c3e50;">source</span> ~/workspace/virtualenv/qtile-devel/bin/activate
env <span style="color: #3498db;">DISPLAY</span>=${<span style="color: #3498db;">XDISPLAY</span>} ${<span style="color: #3498db;">PYTHON</span>} <span style="color: #16a085;">"${HERE}"</span>/../bin/qtile -l ${<span style="color: #3498db;">LOG_LEVEL</span>} $<span style="color: #3498db;">@</span> &amp;
<span style="color: #3498db;">QTILE_PID</span>=$<span style="color: #3498db;">!</span>

<span style="color: #2c3e50;">export</span> <span style="color: #3498db;">DISPLAY</span>=${<span style="color: #3498db;">XDISPLAY</span>}
<span style="color: #2c3e50;">cd</span> ~/workspace/python/qtile
sleep 0.5
./bin/qtile-cmd -o screen -f info
<span style="color: #3498db;">EXIT_CODE</span>=$<span style="color: #3498db;">?</span>

<span style="color: #2c3e50;">kill</span> -9 $<span style="color: #3498db;">QTILE_PID</span>
<span style="color: #2c3e50;">kill</span> $<span style="color: #3498db;">XEPHYR_PID</span>

<span style="color: #2c3e50; font-style: italic;">exit</span> $<span style="color: #3498db;">EXIT_CODE</span>
</pre>
</div>
<div class="taglist"><a href="https://whatacold.github.io/tags.html">Tags</a>: <a href="https://whatacold.github.io/tag-git.html">Git</a> <a href="https://whatacold.github.io/tag-troubleshooting.html">troubleshooting</a> </div>
<div class="post-date">01 Dec 2019</div><h1 class="post-title"><a href="https://whatacold.github.io/2019-12-01-why-cant-git-fetch-remote-branches-other-than-master.html">Why can't Git fetch remote branches other than master?</a></h1>
<p>
Last week I came into a problem with Git, that I can't fetch the remote branch that I pushed to. It was so weird because I can push the local branch there. It never happens before, and it happened when I was in a rush to rebase my code, as someone in my team pushed his code.
</p>

<p>
After searching, it seemed that the configuration of <code>fetch</code> of that repo was different(this <a href="https://stackoverflow.com/questions/11623862/fetch-in-git-doesnt-get-all-branches">Stack Overflow</a> thread for example) than before, it was specified that only <code>master</code> can be fetched. It worked after I changed it to <code>+refs/heads/*:refs/remotes/origin/*</code>.
</p>

<p>
I reflected why it happened after work, the only difference I can remember was that I clone that repo with the option <code>--depth &lt;N&gt;</code>, that is, it was a shallow clone to save disk space.
</p>

<p>
Today I had some time at hand, and I confirmed that the option is the problem by reading the git-clone(1) manpage, it notes that:
</p>
<pre class="example">
--depth &lt;depth&gt;
    Create a shallow clone with a history truncated to the specified number of commits. Implies --single-branch unless
    --no-single-branch is given to fetch the histories near the tips of all branches.
</pre>

<p>
Let's demonstrate it by cloning my dotfiles repo with different options, and it shows clearly that Git will only fetch <code>master</code> of the remote repo if only specifying <code>--depth</code>:
</p>

<div class="org-src-container">
<pre class="src src-shell">$ cd /tmp/
$ git clone --depth 1 https://github.com/whatacold/dotfiles.git dotfiles-depth1
$ git clone --no-single-branch --depth 1 https://github.com/whatacold/dotfiles.git dotfiles-no-single-branch
$ git clone https://github.com/whatacold/dotfiles.git dotfiles-full

$ grep <span style="color: #16a085;">'remote "origin"'</span> -A 2 dotfiles-depth1/.git/config 
[remote <span style="color: #16a085;">"origin"</span>]
    <span style="color: #3498db;">url</span> = https://github.com/whatacold/dotfiles.git
    <span style="color: #3498db;">fetch</span> = +refs/heads/master:refs/remotes/origin/master

$ grep <span style="color: #16a085;">'remote "origin"'</span> -A 2 dotfiles-no-single-branch/.git/config 
[remote <span style="color: #16a085;">"origin"</span>]
    <span style="color: #3498db;">url</span> = https://github.com/whatacold/dotfiles.git
    <span style="color: #3498db;">fetch</span> = +refs/heads/*:refs/remotes/origin/*

$ grep <span style="color: #16a085;">'remote "origin"'</span> -A 2 dotfiles-full/.git/config
[remote <span style="color: #16a085;">"origin"</span>]
    <span style="color: #3498db;">url</span> = https://github.com/whatacold/dotfiles.git
    <span style="color: #3498db;">fetch</span> = +refs/heads/*:refs/remotes/origin/*
</pre>
</div>

<p>
I don't know why <code>--single-branch</code> should be implied by default, at least for me, I just want to fetch all the remote branches.
</p>
<div class="taglist"><a href="https://whatacold.github.io/tags.html">Tags</a>: <a href="https://whatacold.github.io/tag-git.html">Git</a> </div>
<div class="post-date">24 Sep 2019</div><h1 class="post-title"><a href="https://whatacold.github.io/2019-09-24-how-to-revert-a-series-of-commits-with-git.html">How to revert a series of commits with Git?</a></h1>
<p>
Sometimes, I need to revert a series of commits that are already pushed, doing a git hard reset is not an option, as someone may already have new commits based on mine.
</p>

<p>
For example, assume that I've made a few commits like below:
</p>

<pre class="example">
65a2c62 * commit 10
25cad43 * commit 9
72ad583 * commit 8
ceebf9a * commit 7
acf8a11 * commit 6
28d526f * commit 5
63af1e2 * commit 4
982c71c * commit 3
0fb4c2d * commit 2
acf9da1 * commit 1
b5f9933 * commit 0
</pre>

<p>
Now for whatever reason, I need to "drop" the changes made by commit 6 to commit 10, that is, go back to commit 5 without deleting commit.
</p>

<p>
How to do that?
</p>

<p>
One way is to use <code>git revert 28d526f..HEAD</code> to reversely revert the commits, which results in below commit history:
</p>

<pre class="example">
66808e5 * Revert "commit 6"
2661e48 * Revert "commit 7"
db86ec6 * Revert "commit 8"
fde9cb5 * Revert "commit 9"
3bf102f * Revert "commit 10"
65a2c62 * commit 10
25cad43 * commit 9
72ad583 * commit 8
ceebf9a * commit 7
acf8a11 * commit 6
28d526f * commit 5
63af1e2 * commit 4
982c71c * commit 3
0fb4c2d * commit 2
acf9da1 * commit 1
</pre>

<p>
It works, but it makes too many commits, in many cases that's not what I want, I'd rather make only one commit.
</p>

<p>
So is there a better way? The other day, I found the soft reset can suite my needs.
</p>

<p>
But how is it possible? Generally, <code>git reset</code> is used to move HEAD around the commits and/or to reset the index and working tree. The magic is that a soft reset can reset HEAD to a specific commit but leave the index and working tree untouched, so if I soft-reset HEAD from "commit 5" to "commit 10", it will move HEAD directly to "commit 10", but let the index as is, so that the index has the diff from "commit 10" to "commit 5" at the same time (<a href="https://davidzych.com/difference-between-git-reset-soft-mixed-and-hard/">Difference between git reset soft, mixed and hard - davidzych.com</a> illustrates different kinds of reset in detail.)
</p>

<p>
Here are the steps:
</p>
<div class="org-src-container">
<pre class="src src-shell">git branch master-bak    <span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">create a backup branch in case commits lost</span>
git reset --hard 28d526f <span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">the commit 5</span>
git reset --soft master-bak
git commit -m <span style="color: #16a085;">"Revert the commits [6,10]"</span>
git diff 28d526f..HEAD   <span style="color: #95a5a6; font-style: italic;"># </span><span style="color: #95a5a6; font-style: italic;">confirm that it doesn't have any diffs</span>
</pre>
</div>

<p>
P.S. It's a bit boring to prepare git commits above, so I bake a helper script to do that:
</p>
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #95a5a6; font-style: italic;">#</span><span style="color: #95a5a6; font-style: italic;">!/bin/</span><span style="color: #2c3e50; font-style: italic;">bash</span>

<span style="color: #3498db;">COUNT</span>=0
<span style="color: #3498db;">REPO</span>=<span style="color: #16a085;">""</span>
<span style="color: #2c3e50; font-style: italic;">if</span> [ $<span style="color: #3498db;">#</span> -ne 2 ]
<span style="color: #2c3e50; font-style: italic;">then</span>
    <span style="color: #2c3e50;">echo</span> <span style="color: #16a085;">"Usage: $0 &lt;REPO-DIR&gt; &lt;COUNT&gt;"</span>
    <span style="color: #2c3e50; font-style: italic;">exit</span> 1
<span style="color: #2c3e50; font-style: italic;">fi</span>
<span style="color: #3498db;">REPO</span>=$<span style="color: #3498db;">1</span>
<span style="color: #3498db;">COUNT</span>=$<span style="color: #3498db;">2</span>

<span style="color: #2c3e50;">echo</span> <span style="color: #16a085;">"Creating the repo and cd'ing into it..."</span>
mkdir -p $<span style="color: #3498db;">REPO</span> &amp;&amp; <span style="color: #2c3e50;">cd</span> $<span style="color: #3498db;">REPO</span>
[ ! -d .git/ ] &amp;&amp; git init .

<span style="color: #2c3e50;">echo</span> <span style="color: #16a085;">"Making commits..."</span>
<span style="color: #2c3e50; font-style: italic;">for</span> i<span style="color: #2c3e50; font-style: italic;"> in</span> <span style="color: #ff00ff;">`seq 0 $COUNT`</span>;
<span style="color: #2c3e50; font-style: italic;">do</span>
    <span style="color: #2c3e50;">echo</span> <span style="color: #16a085;">"modification made by commit $i"</span> &gt;&gt; demo.txt
    git add demo.txt
    git commit -m <span style="color: #16a085;">"commit $i"</span>
<span style="color: #2c3e50; font-style: italic;">done</span>
</pre>
</div>
<div class="taglist"><a href="https://whatacold.github.io/tags.html">Tags</a>: <a href="https://whatacold.github.io/tag-git.html">Git</a> </div>
<div class="post-date">17 Feb 2019</div><h1 class="post-title"><a href="https://whatacold.github.io/zh/2019-01-13-understand-git-submodule.html">如何理解 Git submodule</a></h1>
<p>
Git 虽然很强大，但也有少数命令很难理解。
submodule 就是这么一个例子，其文档教程也不少，比如 <a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules">Git - Submodules - git-scm.com</a> ，
但我之前始终没有真正领悟到如何使用。
</p>

<p>
直到有天看了一条  <a href="https://stackoverflow.com/a/5814351/910978">StackOverflow Answer</a> ，茅塞顿开，才真正理解了 submodule 。
</p>

<p>
submodule 涉及到两个仓库类型：
</p>
<dl class="org-dl">
<dt>submodule</dt><dd>子模块，比如需要使用的第三方库</dd>
<dt>superproject</dt><dd>主仓库，自己的工程，依赖子模块代码</dd>
</dl>

<p>
Git submodule 本质上是两个独立的仓库，各自可以独立地像普通的 repo 一样操作。
同时 superproject 有一个“指针”，记录了它使用的子模块的 commit revision 。
这个“指针”对于从 SVN 转过来的同学来说会比较不适应，因为 SVN External 没有这个设计，
所以 SVN 无法精确控制所使用的子模块 revision  ，更新主仓库时会自动更新其“子模块”的代码为最新的，
如果“子模块”是外部的代码并且不稳定的话，会影响自己的代码。
</p>

<p>
带着这个认知，在 superproject 中更新 submodule 的操作步骤示意如下：
<img src="./images/2019-01-13-git-submodule-diagram.png" alt="2019-01-13-git-submodule-diagram.png">
</p>

<p>
无论是 superproject 还是 submodule ，都像普通的 repo 一样进行 branch, add, push, diff 等等的操作，
只是最后再通过 <code>git submodule</code> 命令再更新下新“指针”位置即可。</p>
<div class="taglist"><a href="https://whatacold.github.io/tags.html">Tags</a>: <a href="https://whatacold.github.io/tag-git.html">Git</a> </div><div id="archive">
<a href="https://whatacold.github.io/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status"></div>
</body>
</html>
